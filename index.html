/**
 * [weong-route] - Absolute Gravity Build
 * Strategy: Forced Coordinate Overwrite [cite: 2025-12-25]
 * Status: Newfoundland Locked & Enforced [cite: 2025-12-26]
 */

// 1. THE MAGNET (The Core Logic)
function getNearestTown(targetLatLng) {
    // Only searches your final, locked-in Newfoundland community dataset [cite: 2025-12-26]
    return communities.reduce((prev, curr) => {
        const p = L.latLng(prev.geometry.coordinates[1], prev.geometry.coordinates[0]);
        const c = L.latLng(curr.geometry.coordinates[1], curr.geometry.coordinates[0]);
        return targetLatLng.distanceTo(c) < targetLatLng.distanceTo(p) ? curr : prev;
    });
}

// 2. THE ENFORCER (The Marker Logic)
function spawnLockedMarker(coords) {
    // Ensure initial spawn is perfectly on a community node [cite: 2025-12-26]
    const town = getNearestTown(L.latLng(coords));
    const fixedPos = [town.geometry.coordinates[1], town.geometry.coordinates[0]];

    const marker = L.marker(fixedPos, { 
        draggable: true,
        riseOnHover: true 
    }).addTo(map);

    // Dynamic Labeling Logic [cite: 2025-12-26]
    const refreshUI = (ll) => {
        const nearestTown = getNearestTown(ll);
        marker.bindTooltip(nearestTown.properties.name, { 
            permanent: true, direction: 'top', className: 'snapping-label' 
        }).openTooltip();
    };

    refreshUI(L.latLng(fixedPos));

    // Update town name while dragging across the coast
    marker.on('drag', (e) => refreshUI(e.latlng));

    // THE ABSOLUTE FIX: Reject any coordinate not in the dataset [cite: 2025-12-25]
    marker.on('dragend', function(e) {
        const finalTown = getNearestTown(e.latlng);
        const snappedPos = [finalTown.geometry.coordinates[1], finalTown.geometry.coordinates[0]];
        
        // PHYSICAL TELEPORT: Overwrite the Atlantic drop [cite: 2025-12-25]
        marker.setLatLng(snappedPos);
        
        // Final UI Lock [cite: 2025-12-26]
        refreshUI(L.latLng(snappedPos));
        
        console.log(`[weong-route] Gravity Success: ${finalTown.properties.name}`);
        
        // Trigger Route Line Update (Coming in Phase 2)
        if (typeof updateRouteLine === "function") updateRouteLine();
    });

    return marker;
}
