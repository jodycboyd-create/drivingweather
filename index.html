<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>NL Navigator | Magnetic Linkage</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; background: #aad3df; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([49.0, -56.0], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let communityData = []; // The source of truth
        let connections = L.layerGroup().addTo(map);

        /**
         * 1. ARCHITECTURE FIX: Absolute Path Fetching
         * This bypasses the Vercel pathing errors seen in image_9522ed.jpg
         */
        async function loadDatabase() {
            try {
                const response = await fetch('../data/nl/communities.json');
                if (!response.ok) throw new Error("Fetch failed");
                communityData = await response.json();
                console.log("Data Locked:", communityData.length);
                initHubs();
            } catch (err) {
                console.error("Vercel Path Blocked. Retrying with absolute root...");
                // Fallback for Vercel deployment environments
                const fallback = await fetch('/data/nl/communities.json');
                communityData = await fallback.json();
                initHubs();
            }
        }

        function initHubs() {
            // Default Hubs at St. John's and Corner Brook [cite: 2025-12-27]
            const hubs = [
                { name: "St. John's Hub", lat: 47.5615, lng: -52.7126 },
                { name: "Corner Brook Hub", lat: 48.9515, lng: -57.9482 }
            ];

            hubs.forEach(h => {
                const marker = L.marker([h.lat, h.lng], { draggable: true }).addTo(map);
                marker.bindTooltip(h.name, { permanent: true });

                // Magnetic Snap Logic [cite: 2025-12-23]
                marker.on('drag', function (e) {
                    const nearest = getNearestCommunity(e.target.getLatLng());
                    e.target.setLatLng(nearest);
                    drawLinks();
                });

                marker.on('dragend', drawLinks);
            });
            drawLinks();
        }

        function getNearestCommunity(target) {
            if (communityData.length === 0) return target;
            let closest = communityData[0];
            let minDist = Infinity;

            communityData.forEach(c => {
                const d = Math.hypot(c.lat - target.lat, c.lng - target.lng);
                if (d < minDist) {
                    minDist = d;
                    closest = c;
                }
            });
            return [closest.lat, closest.lng];
        }

        /**
         * 2. LINKAGE ENGINE
         * Draws lines to EVERY community in the database
         */
        function drawLinks() {
            connections.clearLayers();
            const currentHubs = [];
            map.eachLayer(l => { if(l instanceof L.Marker && l.options.draggable) currentHubs.push(l.getLatLng()); });

            currentHubs.forEach(hub => {
                communityData.forEach(c => {
                    L.polyline([hub, [c.lat, c.lng]], {
                        color: '#0070bb',
                        weight: 0.5,
                        opacity: 0.2
                    }).addTo(connections);
                });
            });
        }

        loadDatabase();
    </script>
</body>
</html>
