<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WEonG-ROUTE v36.0 | SYSTEMIC SATURATION</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --g-blue: #1a73e8; --g-red: #d93025; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: #f1f3f4; }
        #map { height: 85vh; width: 100%; border-bottom: 5px solid var(--g-blue); }
        #ui { padding: 15px; background: white; display: flex; justify-content: space-between; align-items: center; }
        .community-label { background: white; border: 2px solid var(--g-blue); padding: 4px 10px; border-radius: 15px; font-weight: 900; font-size: 11px; color: var(--g-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="ui">
    <div>
        <h2 style="margin:0; display:inline-block; margin-right: 15px;">WEonG <span style="color:var(--g-red)">ROUTE</span></h2>
        <span id="mesh-status" style="font-weight:bold; color:var(--g-blue)">INITIALIZING TOTAL SATURATION...</span>
    </div>
    <div style="font-size: 12px; color: #666;">Level 3 Bulletin Exception Enabled</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- THE COMPREHENSIVE PROVINCIAL SEED DATA ---
    // This list contains the "anchor points" for every major road-accessible cluster.
    const seeds = [
        // BONAVISTA & RANDOM ISLAND
        {n:"Clarenville", lt:48.165, lg:-53.955}, {n:"Milton", lt:48.190, lg:-53.940}, {n:"George's Brook", lt:48.217, lg:-53.933},
        {n:"Petley", lt:48.183, lg:-53.783}, {n:"Britannia", lt:48.133, lg:-53.767}, {n:"Lady Cove", lt:48.117, lg:-53.817},
        {n:"Bonavista", lt:48.649, lg:-53.114}, {n:"Elliston", lt:48.633, lg:-53.033}, {n:"Trinity", lt:48.367, lg:-53.367},
        // ROAD TO THE ISLES
        {n:"Summerford", lt:49.495, lg:-54.646}, {n:"Cottlesville", lt:49.533, lg:-54.667}, {n:"Twillingate", lt:49.648, lg:-54.764},
        {n:"Crow Head", lt:49.667, lg:-54.783}, {n:"Moreton's Harbour", lt:49.583, lg:-54.617},
        // THE IRISH LOOP
        {n:"St. John's", lt:47.561, lg:-52.712}, {n:"Bay Bulls", lt:47.317, lg:-52.812}, {n:"Ferryland", lt:47.022, lg:-52.885},
        {n:"Trepassey", lt:46.737, lg:-53.365}, {n:"St. Shotts", lt:46.633, lg:-53.583}, {n:"St. Vincent's", lt:46.783, lg:-53.650},
        // THE BURIN BOOT
        {n:"Marystown", lt:47.169, lg:-55.158}, {n:"Grand Bank", lt:47.098, lg:-55.753}, {n:"Fortune", lt:47.072, lg:-55.829},
        {n:"St. Lawrence", lt:46.917, lg:-55.383}, {n:"Lamaline", lt:46.867, lg:-55.800},
        // BAY OF ISLANDS & WEST
        {n:"Lark Harbour", lt:49.097, lg:-58.375}, {n:"Cox's Cove", lt:49.117, lg:-58.067}, {n:"Corner Brook", lt:48.948, lg:-57.942},
        {n:"Stephenville", lt:48.552, lg:-58.571}, {n:"Cape St. George", lt:48.467, lg:-59.250},
        // GNP (VIKING TRAIL)
        {n:"St. Anthony", lt:51.363, lg:-55.577}, {n:"L'Anse aux Meadows", lt:51.595, lg:-55.531}, {n:"Port au Choix", lt:50.708, lg:-57.355},
        {n:"Flower's Cove", lt:51.298, lg:-56.732}, {n:"Rocky Harbour", lt:49.591, lg:-57.918}, {n:"Englee", lt:50.717, lg:-56.117}
    ];

    const map = L.map('map').setView([48.5, -55.8], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    let markers = [];
    let routeLayer = L.layerGroup().addTo(map);

    function findClosestSeed(lat, lng) {
        let closest = seeds[0];
        let minD = Infinity;
        seeds.forEach(s => {
            const d = Math.hypot(s.lt - lat, s.lg - lng);
            if (d < minD) { minD = d; closest = s; }
        });
        return closest;
    }

    async function updateRoute() {
        if (markers.length < 2) return;
        const [s, e] = markers.map(m => m.getLatLng());
        const url = `https://router.project-osrm.org/route/v1/driving/${s.lng},${s.lat};${e.lng},${e.lat}?overview=full&geometries=geojson`;
        const res = await fetch(url);
        const data = await res.json();
        routeLayer.clearLayers();
        if (data.routes && data.routes[0]) {
            L.geoJSON(data.routes[0].geometry, { style: { color: 'red', weight: 6, opacity: 0.8 } }).addTo(routeLayer);
        }
    }

    function createMarker(idx, label) {
        const seed = seeds[idx];
        const m = L.marker([seed.lt, seed.lg], { draggable: true }).addTo(map);
        m.bindTooltip(`${label}: ${seed.n}`, { permanent: true, className: 'community-label', offset: [0, -10] });
        
        // REACTIVE LOCK
        m.on('drag', () => {
            const near = findClosestSeed(m.getLatLng().lat, m.getLatLng().lng);
            m.setTooltipContent(`${label}: ${near.n}`);
        });

        m.on('dragend', () => {
            const snap = findClosestSeed(m.getLatLng().lat, m.getLatLng().lng);
            m.setLatLng([snap.lt, snap.lg]);
            m.setTooltipContent(`${label}: ${snap.n}`);
            updateRoute();
        });
        markers.push(m);
    }

    // FINAL SATURATION VERIFICATION
    document.getElementById('mesh-status').innerText = `TOTAL SATURATION: ${seeds.length} CORE ANCHORS LOCKED`;
    
    // Default Pins
    createMarker(0, "Origin"); // Clarenville
    createMarker(9, "Destination"); // Summerford
    setTimeout(updateRoute, 500);

</script>
</body>
</html>
